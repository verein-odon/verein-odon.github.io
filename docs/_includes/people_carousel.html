<section class="section bg-{{ include.bg_color | default: 'gray' }}">
  <div class="container">
    <div class="content-section">
      <div class="icon-header">
        <div>
          <h2 id="people-carousel-heading">{{ include.title }}</h2>
        </div>
      </div>
      {% if include.intro %}
      <p>{{ include.intro }}</p>
      {% endif %}
    </div>

    {% assign all_people = site.data.people %}
    {% if all_people.size > 0 %}
    <div class="people-carousel" data-carousel role="region" aria-labelledby="people-carousel-heading">
      <div class="people-carousel-inner">
        {% for person in all_people %}
        <article class="person-slide{% if forloop.first %} is-active{% endif %}" data-carousel-slide>
          <div class="person-card">
            <button type="button" class="person-side-avatar left" data-carousel-prev aria-label="Previous person">
              <span class="person-side-avatar-inner" aria-hidden="true"></span>
            </button>

            <div class="person-main">
              <div class="person-image-wrapper">
                <img src="/assets/images/people/{{ person.image }}" alt="{{ person.name }}" class="person-image" loading="lazy" width="200" height="200">
              </div>
              <h3 class="person-name">{{ person.name }}</h3>
              {% if person.role and person.role != "" %}
              <p class="person-role">{{ person.role }}</p>
              {% endif %}
              {% if person.statement and person.statement != "" %}
              <blockquote class="person-statement">{{ person.statement }}</blockquote>
              {% endif %}
              {% if person.link and person.link != "" %}
              <a href="{{ person.link }}" class="person-link" target="_blank" rel="noopener noreferrer" aria-label="{{ include.profile_label | default: 'Profile' }} (opens in new tab)">
                {{ include.profile_label | default: "Profile" }}
              </a>
              {% endif %}
            </div>

            <button type="button" class="person-side-avatar right" data-carousel-next aria-label="Next person">
              <span class="person-side-avatar-inner" aria-hidden="true"></span>
            </button>
          </div>
        </article>
        {% endfor %}
      </div>

      <div class="people-carousel-controls">
        <button type="button" class="carousel-btn prev" data-carousel-prev aria-label="Previous person">
          &#x2039;
        </button>
        <button type="button" class="carousel-btn next" data-carousel-next aria-label="Next person">
          &#x203A;
        </button>
      </div>
      <div class="people-carousel-dots" role="tablist" aria-label="Choose featured person" data-carousel-dots></div>
    </div>
    {% endif %}
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function () {
  var carousels = document.querySelectorAll('[data-carousel]');
  if (!carousels.length) return;

  carousels.forEach(function (carousel) {
    var MAX_SLIDES = 3;
    var inner = carousel.querySelector('.people-carousel-inner');
    var slides = Array.prototype.slice.call(carousel.querySelectorAll('[data-carousel-slide]'));
    if (!slides.length || !inner) return;

    // Shuffle slides (random selection on each page load)
    for (var i = slides.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var tmp = slides[i];
      slides[i] = slides[j];
      slides[j] = tmp;
    }

    // Re-append shuffled slides in DOM order
    slides.forEach(function (slide) {
      inner.appendChild(slide);
    });

    // Keep at most MAX_SLIDES
    if (slides.length > MAX_SLIDES) {
      slides.slice(MAX_SLIDES).forEach(function (slide) {
        slide.parentNode && slide.parentNode.removeChild(slide);
      });
      slides = slides.slice(0, MAX_SLIDES);
    }

    // Set side avatars to show blurred adjacent person images (prev/next)
    var total = slides.length;
    function getPersonImageUrl(slide) {
      var img = slide && slide.querySelector('.person-image');
      return img && img.src ? img.src : '';
    }
    slides.forEach(function (slide, idx) {
      var prevIdx = (idx - 1 + total) % total;
      var nextIdx = (idx + 1) % total;
      var prevUrl = getPersonImageUrl(slides[prevIdx]);
      var nextUrl = getPersonImageUrl(slides[nextIdx]);
      var leftInner = slide.querySelector('.person-side-avatar.left .person-side-avatar-inner');
      var rightInner = slide.querySelector('.person-side-avatar.right .person-side-avatar-inner');
      if (leftInner && prevUrl) {
        leftInner.style.backgroundImage = 'url(' + prevUrl + ')';
        leftInner.classList.add('person-side-avatar-inner--blur');
      }
      if (rightInner && nextUrl) {
        rightInner.style.backgroundImage = 'url(' + nextUrl + ')';
        rightInner.classList.add('person-side-avatar-inner--blur');
      }
    });

    var prevBtns = carousel.querySelectorAll('[data-carousel-prev]');
    var nextBtns = carousel.querySelectorAll('[data-carousel-next]');
    var dotsContainer = carousel.querySelector('[data-carousel-dots]');
    var dots = [];
    var current = 0;
    var carouselId = 'people-carousel-' + (Math.random().toString(36).slice(2, 9));

    // Assign slide IDs and ARIA for tablist/tabpanel pattern
    slides.forEach(function (slide, idx) {
      var panelId = carouselId + '-panel-' + idx;
      slide.id = panelId;
      slide.setAttribute('role', 'tabpanel');
      var nameEl = slide.querySelector('.person-name');
      var name = nameEl ? nameEl.textContent.trim() : ('Person ' + (idx + 1));
      slide.setAttribute('aria-label', name);
    });

    function rebuildDots() {
      if (!dotsContainer) return;
      dotsContainer.innerHTML = '';
      dots = [];

      slides.forEach(function (slide, idx) {
        var nameEl = slide.querySelector('.person-name');
        var name = nameEl ? nameEl.textContent.trim() : ('Person ' + (idx + 1));
        var panelId = slide.id;

        var dot = document.createElement('button');
        dot.type = 'button';
        dot.className = 'carousel-dot' + (idx === 0 ? ' is-active' : '');
        dot.setAttribute('role', 'tab');
        dot.setAttribute('aria-selected', idx === 0 ? 'true' : 'false');
        dot.setAttribute('aria-controls', panelId);
        dot.setAttribute('data-carousel-dot', String(idx));
        dot.setAttribute('aria-label', 'Show ' + name);
        dot.setAttribute('tabindex', idx === 0 ? '0' : '-1');
        dotsContainer.appendChild(dot);
        dots.push(dot);
      });
    }

    function showSlide(index) {
      if (!slides.length) return;
      var total = slides.length;
      current = (index + total) % total;

      slides.forEach(function (slide, i) {
        var isActive = i === current;
        slide.classList.toggle('is-active', isActive);
        slide.setAttribute('aria-hidden', isActive ? 'false' : 'true');
      });

      dots.forEach(function (dot, i) {
        var isActive = i === current;
        dot.classList.toggle('is-active', isActive);
        dot.setAttribute('aria-selected', isActive ? 'true' : 'false');
        dot.setAttribute('tabindex', isActive ? '0' : '-1');
      });
    }

    prevBtns.forEach(function (btn) {
      btn.addEventListener('click', function () {
        showSlide(current - 1);
      });
    });

    nextBtns.forEach(function (btn) {
      btn.addEventListener('click', function () {
        showSlide(current + 1);
      });
    });

    rebuildDots();

    dots.forEach(function (dot) {
      dot.addEventListener('click', function () {
        var idx = parseInt(dot.getAttribute('data-carousel-dot'), 10);
        if (!isNaN(idx)) showSlide(idx);
      });
    });

    if (dotsContainer) {
      dotsContainer.addEventListener('keydown', function (e) {
        var target = e.target;
        if (target.getAttribute('role') !== 'tab') return;
        var idx = parseInt(target.getAttribute('data-carousel-dot'), 10);
        if (isNaN(idx)) return;
        var nextIdx = idx;
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          nextIdx = (idx - 1 + slides.length) % slides.length;
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          nextIdx = (idx + 1) % slides.length;
        } else return;
        showSlide(nextIdx);
        dots[nextIdx].focus();
      });
    }

    // Hide controls/dots/side avatars when there's only one featured person
    var controls = carousel.querySelector('.people-carousel-controls');
    var sideAvatars = carousel.querySelectorAll('.person-side-avatar');
    if (slides.length <= 1) {
      if (controls) controls.style.display = 'none';
      if (dotsContainer) dotsContainer.style.display = 'none';
      sideAvatars.forEach(function (btn) {
        btn.style.display = 'none';
      });
    }

    showSlide(current);
  });
});
</script>

